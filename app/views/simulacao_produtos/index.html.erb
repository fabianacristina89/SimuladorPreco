<%- model_class = SimulacaoProduto.new.class -%>
<%- 

-%>

<script>
$('#navbar').scrollspy()

$('#precoCompra').keyup(function() {
 alert("Key up detected");
});

function recalcularTabelaDePrecos(event){
  var arrayLinhas = document.getElementById('tabela_precos').getElementsByTagName('tr');
  for(var i = 0; i<arrayLinhas.length; i++){
    recalcularLinha(event, arrayLinhas[i]);
  }
}

function calcularValor(event,input){
  formatar(event,input);
  

  var tr = input.parentNode.parentNode.parentNode;
  recalcularLinha(event, tr);

}
function recalcularLinha(event,tr){
   var arrayDespesasFixas = tr.getElementsByClassName("despesa_variavel");
  var somaPorcentagem = 0;

  for(var i = 0; i<arrayDespesasFixas.length; i++){
    somaPorcentagem = somaPorcentagem + parseCurrencyToFloat(arrayDespesasFixas[i].value)
  }
  somaPorcentagem = somaPorcentagem + parseCurrencyToFloat(document.getElementById("simulacao_despesas_fixas").value);
  somaPorcentagem = somaPorcentagem + parseCurrencyToFloat(document.getElementById("simulacao_margem_lucro").value);

  var markup = 100 - somaPorcentagem;
  var valor = parseCurrencyToFloat(tr.getElementsByClassName("preco_compra")[0].value)/(markup/100);

  tr.getElementsByClassName("valor_calculado")[0].value = valor.toFixed(2);
  formatar(event,tr.getElementsByClassName("valor_calculado")[0]);
}


</script>


<body data-spy="scroll">





  <header class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a href="#" class="brand">Simulador de Precos</a>
        <ul class="nav">
          <li><a href="#">Home</a></li>
          <li><a href="#">Simular</a></li>
          <li><a href="#">Ajuda</a></li>
          <li><a href="#">Sobre</a></li>
          <li><a href="http://www.vpsa.com.br">VPSA</a></li>
        </ul>
       </div>
      </div>
    </header>
  
  <%= render :partial => 'new_simulacao' %>
</body>
<div>
 

</div>


<table class="table table-striped" >
  <thead>
    <tr>
      <th><%= model_class.human_attribute_name(:nome) %></th>
      <th><%= model_class.human_attribute_name(:preco_compra) %></th>
      <th><%= model_class.human_attribute_name(:icms) %></th>
      <th><%= model_class.human_attribute_name(:ipi) %></th>
      <th><%= model_class.human_attribute_name(:outros_impostos) %></th>
      <th><%= model_class.human_attribute_name(:comissao) %></th>
      <th><%= model_class.human_attribute_name(:frete) %></th>
      <th><%= model_class.human_attribute_name(:outros_custos) %></th>
      <th><%= model_class.human_attribute_name(:preco_calculado) %></th>
      <th><%= model_class.human_attribute_name(:preco_vpsa) %></th>
    </tr>
  </thead>
  <tbody id="tabela_precos">
    <% @lista_final.each do |produto| %>
     <%= form_for produto,  :html => { :class => 'form-horizontal', :remote => true } do |f| %>
      <div class="control-group"> 
     <tr>
       <td><%= produto["descricao"] %> - <%= produto["produto_vpsa_id"] %></td>
       <td style="white-space:nowrap;"><div class="input-prepend"><span class="add-on">R$</span><%= f.text_field :preco_compra,:id => "precoCompra", :class => 'text_field preco_compra', :style => 'width:60px;', :onkeyup => "calcularValor(event, this);"%></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :icms, :class => 'text_field despesa_variavel', :style => 'width:60px;', :onkeyup => "calcularValor(event, this);"%><span class="add-on">%</span></div></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :ipi, :onkeyup => "calcularValor(event, this);" , :class => 'text_field despesa_variavel' , :style => 'width:60px;' %><span class="add-on">%</span></div></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :outros_impostos, :onkeyup => "calcularValor(event, this);", :class => 'text_field despesa_variavel', :style => 'width:60px;' %><span class="add-on">%</span></div></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :comissao, :onkeyup => "calcularValor(event, this);", :class => 'text_field despesa_variavel', :style => 'width:60px;' %><span class="add-on">%</span></div></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :frete, :onkeyup => "calcularValor(event, this);", :class => 'text_field despesa_variavel', :style => 'width:60px;' %><span class="add-on">R$</span></div></td>
        <td style="white-space:nowrap;"><div class="input-append"><%= f.text_field :outros_custos, :onkeyup => "calcularValor(event, this);", :class => 'text_field despesa_variavel', :style => 'width:60px;' %><span class="add-on">%</span></div></td>
        <td style="white-space:nowrap;"><div class="input-prepend"><span class="add-on">R$</span><%= f.text_field :preco_calculado, :class => 'text_field valor_calculado', :style => 'width:60px;' , :disabled=> true%></div>
          <%= f.hidden_field :produto_vpsa_id, :value => produto["produto_vpsa_id"] %>
      </td>
      <td style="white-space:nowrap;"><div class="input-prepend"><span class="add-on">R$</span><%= f.text_field :preco_vpsa, :class => 'text_field', :style => 'width:60px;', :disabled=> true%></div></td>

        <td>

	
	

        <%=  image_submit_tag("salvarAzul32.png", :class => "botao_env")%>

  </td>

      </tr>
    </div>
     <% end %>
    <% end %>
  </tbody>
</table>

<%= link_to t('.new', :default => t("helpers.links.new")),
            new_simulacao_produto_path,
            :class => 'btn btn-primary' %>